<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Automatická AR Šipka</title>
<style>
  body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
  
  /* Video na pozadí */
  video { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 0; }
  
  /* Canvas pro 3D */
  canvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
  
  /* UI */
  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    background: rgba(0,0,0,0.5); /* Zatmavení před startem */
  }

  /* Tlačítko musí zůstat kvůli Apple bezpečnosti */
  button {
    background: #FF3B30; /* Výrazná červená */
    color: white; border: none; border-radius: 50px;
    padding: 20px 40px; font-size: 20px; font-weight: bold;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    cursor: pointer;
  }
  
  #status {
    position: fixed; top: 20px; left: 0; width: 100%;
    text-align: center; color: white; font-weight: bold;
    text-shadow: 0 2px 4px black; z-index: 3; display: none;
    font-size: 18px;
  }
</style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>

<div id="status">Kalibruji senzory... držte telefon rovně</div>

<div id="overlay">
  <button id="start">SPUSTIT AR</button>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { DeviceOrientationControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/DeviceOrientationControls.js';

const startBtn = document.getElementById("start");
const overlay = document.getElementById("overlay");
const statusText = document.getElementById("status");

let scene, camera, renderer, controls;
let arrowMesh;
const CAMERA_HEIGHT = 1.6; // Výška očí (cca 160cm od země)

startBtn.onclick = async () => {
  // 1. Vyžádání povolení (iOS requirement)
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const permission = await DeviceOrientationEvent.requestPermission();
      if (permission !== 'granted') {
        alert("Musíte povolit přístup k senzorům, jinak AR nebude fungovat.");
        return;
      }
    } catch (e) {
      console.error(e);
    }
  }

  // Skryjeme tlačítko
  overlay.style.display = "none";
  statusText.style.display = "block";
  
  // Spustíme logiku
  init();
};

function init() {
  // 2. Kamera
  const video = document.getElementById("camera");
  navigator.mediaDevices.getUserMedia({ 
    video: { facingMode: "environment" } 
  }).then(stream => {
    video.srcObject = stream;
  });

  // 3. Three.js Scéna
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
  
  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Světlo
  const light = new THREE.DirectionalLight(0xffffff, 1.5);
  light.position.set(0, 10, 5);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0xffffff, 0.5));

  // 4. Ovládání orientace
  controls = new DeviceOrientationControls(camera);
  
  // 5. AUTOMATICKÉ UMÍSTĚNÍ
  // Počkáme 1.5 sekundy, než se senzory "usadí", a pak vystřelíme šipku
  setTimeout(() => {
    placeArrowAutomatically();
    statusText.innerText = "Šipka umístěna";
    setTimeout(() => { statusText.style.display = 'none'; }, 2000); // Schovat text po chvíli
  }, 1500);

  animate();
}

function create3DArrow() {
  const group = new THREE.Group();
  const material = new THREE.MeshStandardMaterial({ color: 0xff0000 }); // Červená

  // Tělo šipky
  const shaft = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1.5, 32), material);
  shaft.position.y = -0.75; 
  shaft.rotation.x = -Math.PI / 2; // Ležet na zemi

  // Hrot šipky
  const head = new THREE.Mesh(new THREE.ConeGeometry(0.3, 0.6, 32), material);
  head.position.z = -1.5; // Na konci těla
  head.rotation.x = -Math.PI / 2;

  group.add(shaft);
  group.add(head);
  
  return group;
}

function placeArrowAutomatically() {
  arrowMesh = create3DArrow();

  // Získáme směr, kam se kamera aktuálně dívá
  const vector = new THREE.Vector3();
  camera.getWorldDirection(vector);
  
  // Ignorujeme výšku pohledu, chceme jen směr po zemi
  vector.y = 0; 
  vector.normalize(); 
  vector.multiplyScalar(3); // Vzdálenost 3 metry

  // Nastavíme pozici
  arrowMesh.position.set(vector.x, -CAMERA_HEIGHT, vector.z);

  // Otočíme šipku tak, aby mířila směrem od nás
  const angle = Math.atan2(vector.x, vector.z);
  arrowMesh.rotation.y = angle;

  scene.add(arrowMesh);
}

function animate() {
  requestAnimationFrame(animate);
  if(controls) controls.update();
  renderer.render(scene, camera);
}
</script>
</body>
</html>
