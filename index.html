<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AR Navigace – Krušné hory</title>
<style>
  body { margin:0; overflow:hidden; background:black; font-family: sans-serif; }
  video { position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:0; }
  canvas { position:fixed; top:0; left:0; z-index:1; pointer-events: none; }
  #ui {
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    z-index:2; text-align: center; color: white; background: rgba(0,0,0,0.6);
    padding: 15px; border-radius: 20px; width: 80%;
  }
  button {
    padding:15px 30px; background:#e67e22; color:white; border:none;
    border-radius: 50px; font-size:18px; font-weight: bold; margin-bottom: 10px;
  }
</style>
</head>
<body>

<div id="ui">
  <button id="start">Spustit navigaci</button>
  <div id="status">Čekám na start...</div>
</div>
<video id="camera" autoplay playsinline></video>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js';

const uiStatus = document.getElementById("status");
const startBtn = document.getElementById("start");

// Souřadnice Klínovce (Krušné hory)
const TARGET_COORDS = { lat: 50.395, lon: 12.967 };
let userCoords = null;
let bearingToTarget = 0;

let scene, camera, renderer, arrow;

// 1. Výpočet azimutu (směru) k cíli
function calculateBearing(lat1, lon1, lat2, lon2) {
  const l1 = lat1 * Math.PI / 180;
  const l2 = lat2 * Math.PI / 180;
  const dl = (lon2 - lon1) * Math.PI / 180;
  const y = Math.sin(dl) * Math.cos(l2);
  const x = Math.cos(l1) * Math.sin(l2) - Math.sin(l1) * Math.cos(l2) * Math.cos(dl);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

// 2. Povolení senzorů a GPS
startBtn.onclick = async () => {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    const res = await DeviceOrientationEvent.requestPermission();
    if (res !== 'granted') return alert("Potřebujeme senzory!");
  }

  startBtn.style.display = "none";
  uiStatus.innerText = "Hledám GPS...";

  navigator.geolocation.watchPosition(pos => {
    userCoords = pos.coords;
    bearingToTarget = calculateBearing(userCoords.latitude, userCoords.longitude, TARGET_COORDS.lat, TARGET_COORDS.lon);
    uiStatus.innerText = `Klínovec je cca ${bearingToTarget.toFixed(0)}° od severu`;
  }, err => {
    uiStatus.innerText = "GPS nedostupná.";
  }, { enableHighAccuracy: true });

  initAR();
};

function initAR() {
  // Kamera (video feed)
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
    document.getElementById("camera").srcObject = s;
  });

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  
  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Vytvoření cesty/šipky
  const arrowGeo = new THREE.ConeGeometry(0.5, 5, 3); // Trojúhelníková cesta
  arrowGeo.rotateX(Math.PI / 2); // Položit na zem
  const arrowMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
  arrow = new THREE.Mesh(arrowGeo, arrowMat);
  arrow.position.y = -2; // Pod nohama
  scene.add(arrow);

  // Pomocné světlo
  scene.add(new THREE.AmbientLight(0xffffff, 1));

  // Sledování kompasu na iOS
  window.addEventListener('deviceorientationabsolute', handleOrientation, true);
  window.addEventListener('deviceorientation', handleOrientation, true);

  animate();
}

function handleOrientation(event) {
  let compass = event.webkitCompassHeading || event.alpha;
  if (compass === undefined) return;

  // Three.js rotace kamery podle kompasu
  // Alpha je rotace kolem osy Z (vzhůru)
  const alpha = THREE.MathUtils.degToRad(compass);
  const beta = THREE.MathUtils.degToRad(event.beta);
  const gamma = THREE.MathUtils.degToRad(event.gamma);

  // Nastavíme rotaci scény tak, aby nula byla vždy na Severu
  // a šipka mířila k vypočítanému azimutu
  camera.rotation.set(beta, gamma, -alpha, 'YXZ');
  
  if (arrow) {
    // Šipka se otočí směrem k cíli (vzhledem k severu)
    const targetRad = THREE.MathUtils.degToRad(-bearingToTarget);
    arrow.rotation.y = targetRad;
  }
}

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
</script>
</body>
</html>
