<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AR Krušnohorský Kompas</title>
<style>
  body { margin:0; overflow:hidden; background:black; font-family: -apple-system, sans-serif; }
  video { position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:0; }
  canvas { position:fixed; top:0; left:0; z-index:1; pointer-events: none; }
  #ui {
    position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
    z-index:2; text-align: center; color: white; background: rgba(0,0,0,0.7);
    padding: 20px; border-radius: 25px; width: 85%; backdrop-filter: blur(10px);
  }
  button {
    padding:15px 30px; background:#007AFF; color:white; border:none;
    border-radius: 50px; font-size:18px; font-weight: bold; margin-bottom: 10px;
    box-shadow: 0 4px 15px rgba(0,122,255,0.4);
  }
  #debug { font-size: 11px; color: #aaa; margin-top: 8px; line-height: 1.4; }
</style>
</head>
<body>

<div id="ui">
  <button id="start">Spustit AR Navigaci</button>
  <div id="status">Připraven k vyhledání hor</div>
  <div id="debug"></div>
</div>
<video id="camera" autoplay playsinline></video>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js';

const uiStatus = document.getElementById("status");
const debug = document.getElementById("debug");
const startBtn = document.getElementById("start");

const KLINOVEC = { lat: 50.395, lon: 12.967 };
let bearingToTarget = 0;
let scene, camera, renderer, road;

// Výpočet úhlu k cíli
function getBearing(lat1, lon1, lat2, lon2) {
  const l1 = lat1 * Math.PI / 180;
  const l2 = lat2 * Math.PI / 180;
  const dl = (lon2 - lon1) * Math.PI / 180;
  const y = Math.sin(dl) * Math.cos(l2);
  const x = Math.cos(l1) * Math.sin(l2) - Math.sin(l1) * Math.cos(l2) * Math.cos(dl);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

startBtn.onclick = async () => {
  // 1. Žádost o senzory (iOS)
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const permission = await DeviceOrientationEvent.requestPermission();
      if (permission !== 'granted') {
        uiStatus.innerText = "Senzory zamítnuty";
        return;
      }
    } catch (e) { debug.innerText = "Chyba senzorů: " + e; }
  }

  startBtn.style.display = "none";
  uiStatus.innerText = "Hledám polohu...";

  // 2. Start kamery
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(s => { document.getElementById("camera").srcObject = s; })
    .catch(e => { debug.innerText += "\nKamera nejde (potřebuje HTTPS)"; });

  // 3. Start GPS
  navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      bearingToTarget = getBearing(latitude, longitude, KLINOVEC.lat, KLINOVEC.lon);
      uiStatus.innerText = "Mířím na Klínovec";
      debug.innerText = `Moje GPS: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}\nÚhel: ${bearingToTarget.toFixed(1)}°`;
    },
    err => {
      uiStatus.innerText = "GPS nedostupná - Demo režim";
      debug.innerText = "Chyba: " + err.message + "\n(Používám simulovanou polohu z Prahy)";
      bearingToTarget = getBearing(50.07, 14.43, KLINOVEC.lat, KLINOVEC.lon);
    },
    { enableHighAccuracy: true }
  );

  initThree();
};

function initThree() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Vytvoříme cestu jako dlouhý "koberec" mířící k horám
  const roadGeo = new THREE.PlaneGeometry(2, 100);
  roadGeo.rotateX(-Math.PI / 2);
  roadGeo.translate(0, -1.5, -50); // Posunout před kameru a na zem

  const roadMat = new THREE.MeshBasicMaterial({ 
    color: 0x00ffcc, 
    transparent: true, 
    opacity: 0.5,
    side: THREE.DoubleSide 
  });
  
  road = new THREE.Mesh(roadGeo, roadMat);
  scene.add(road);

  // Přidáme orientační čáry na cestu
  const grid = new THREE.GridHelper(100, 50, 0x00ffcc, 0x004444);
  grid.position.y = -1.49;
  scene.add(grid);

  window.addEventListener('deviceorientation', (e) => {
    // webkitCompassHeading je klíčový pro iPhone
    let heading = e.webkitCompassHeading || (360 - e.alpha);
    
    const alpha = THREE.MathUtils.degToRad(heading);
    const beta = THREE.MathUtils.degToRad(e.beta);
    const gamma = THREE.MathUtils.degToRad(e.gamma);

    // Otáčíme kamerou podle telefonu
    camera.rotation.set(beta, gamma, -alpha, 'YXZ');
    
    // Cesta se v prostoru otočí k cíli
    road.rotation.y = THREE.MathUtils.degToRad(-bearingToTarget);
    grid.rotation.y = THREE.MathUtils.degToRad(-bearingToTarget);
  }, true);

  animate();
}

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
</script>
</body>
</html>
