<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Šipka na zemi</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }
        video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 0;
        }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }
        #start {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            padding: 20px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <button id="start">SPUSTItT AR</button>
    <video id="camera" autoplay playsinline></video>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js';

        const startBtn = document.getElementById("start");
        let scene, camera, renderer, arrowGroup;
        let bearing = 320; // Směr na Krušné hory (uprav si podle potřeby)
        const visibilityThreshold = 30; // Tolerance v stupních

        startBtn.onclick = async () => {
            if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
                await DeviceOrientationEvent.requestPermission();
            }
            startBtn.style.display = "none";
            init();
        };

        function init() {
            // Kamera telefonu (pozadí)
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(s => document.getElementById("camera").srcObject = s);

            scene = new THREE.Scene();

            // Zúžení FOV na 60° pro lepší "přilepení" k realitě
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            arrowGroup = new THREE.Group();
            scene.add(arrowGroup);

            // Vytvoření šipky (trojúhelník)
            const arrowGeometry = new THREE.BufferGeometry();
            const vertices = new Float32Array([
                -0.5, 0, -1,   // levý
                0.5,  0, -1,   // pravý
                0,    0,  1    // hrot
            ]);
            arrowGeometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            arrowGeometry.setIndex([0, 1, 2]);
            arrowGeometry.rotateX(-Math.PI / 2); // položit na zem

            // 20 segmentů pro efekt "cesty" do dálky
            for (let i = 0; i < 20; i++) {
                const material = new THREE.MeshBasicMaterial({
                    color: 0x00ffcc,
                    transparent: true,
                    opacity: 1 - (i * 0.05),
                    side: THREE.DoubleSide
                });
                const segment = new THREE.Mesh(arrowGeometry, material);
                segment.position.set(0, -1.6, -i * 5);
                arrowGroup.add(segment);
            }

            // Sledování orientace zařízení
            window.addEventListener('deviceorientation', (e) => {
                let heading = e.webkitCompassHeading || (360 - e.alpha);
                heading = (heading + 360) % 360;

                const diff = Math.min(
                    Math.abs(heading - bearing) % 360,
                    360 - Math.abs(heading - bearing) % 360
                );
                arrowGroup.visible = (diff <= visibilityThreshold);

                const a = THREE.MathUtils.degToRad(heading);
                const b = THREE.MathUtils.degToRad(e.beta);
                const g = THREE.MathUtils.degToRad(e.gamma);

                // Rotace kamery
                camera.rotation.set(b, g, -a, 'YXZ');

                // Otočení šipky podle cílového směru
                arrowGroup.rotation.y = THREE.MathUtils.degToRad(bearing - heading);
            }, true);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            // Animace "plující" šipky dopředu
            arrowGroup.children.forEach(seg => {
                seg.position.z += 0.1;
                if (seg.position.z > 2) {
                    seg.position.z = -98; // vrátit na začátek řady
                }
            });

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
