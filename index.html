<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Fixní Šipka</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: -apple-system, sans-serif; }
        video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; }
        
        #overlay {
            position: fixed; inset: 0; z-index: 10;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.7);
        }
        button {
            padding: 20px 40px; font-size: 22px; font-weight: bold;
            background: #ff3b30; color: white; border: none; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<div id="overlay">
    <button id="startBtn">SPUSTIT AR</button>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { DeviceOrientationControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/DeviceOrientationControls.js';

let scene, camera, renderer, controls, arrow;
const startBtn = document.getElementById('startBtn');
const overlay = document.getElementById('overlay');

startBtn.addEventListener('click', async () => {
    // 1. Žádost o povolení (iOS 13+)
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const response = await DeviceOrientationEvent.requestPermission();
        if (response !== 'granted') {
            alert('Povolte senzory pohybu v nastavení Safari.');
            return;
        }
    }

    // 2. Kamera
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    document.getElementById('camera').srcObject = stream;

    overlay.style.display = 'none';
    initAR();
});

function initAR() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // Osvětlení
    scene.add(new THREE.AmbientLight(0xffffff, 1));
    const sun = new THREE.DirectionalLight(0xffffff, 2);
    sun.position.set(5, 10, 7);
    scene.add(sun);

    // Senzory pohybu (Rotace kamery)
    controls = new DeviceOrientationControls(camera);

    // Vytvoření šipky (3D jako na obrázku)
    createArrow();

    animate();
}

function createArrow() {
    const group = new THREE.Group();
    const mat = new THREE.MeshStandardMaterial({ color: 0xff0000 });

    // Tělo šipky
    const shaft = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 1.2), mat);
    shaft.rotation.x = Math.PI / 2;
    group.add(shaft);

    // Hrot
    const head = new THREE.Mesh(new THREE.ConeGeometry(0.4, 0.8), mat);
    head.rotation.x = -Math.PI / 2;
    head.position.z = -1;
    group.add(head);

    // UMÍSTĚNÍ: 3 metry před kameru, 1.6m pod úroveň očí (na podlahu)
    // Protože se kamera hned po startu zorientuje, musíme šipku umístit 
    // v jejím aktuálním "výhledu".
    setTimeout(() => {
        const forward = new THREE.Vector3(0, 0, -1);
        forward.applyQuaternion(camera.quaternion);
        forward.y = 0; // Chceme směr po podlaze
        forward.normalize();

        group.position.set(forward.x * 3, -1.6, forward.z * 3);
        
        // Otočit šipku směrem od nás
        group.lookAt(forward.x * 10, -1.6, forward.z * 10);
        
        scene.add(group);
        arrow = group;
    }, 500); // Malá pauza na stabilizaci sensorů
}

function animate() {
    requestAnimationFrame(animate);
    if (controls) controls.update();
    renderer.render(scene, camera);
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
